<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test mtx u preset 03 03 edit mtx search save js</title>

  <style>
    canvas {
      /*width: 100%;*/
      /*height: 100%;*/
      border: 1px solid #000000;
      background-color: beige;
      /*background-color: grey;*/
    }
  </style>
</head>
<body onload="init()">
  <div style="margin:8px">
    <label for="id-input-raw-index">rawIndex (0-124):</label>
    <input type="number" id="id-input-raw-index" name="raw-num" min="0" max="124" value="0" />
    <label for="id-input-size">size :</label>
    <input type="number" id="id-input-size" name="size" min="1" value="6" />
    <label for="id-input-margin-x1">marginX1 :</label>
    <input type="number" id="id-input-margin-x1" name="margin-x1" min="0" value="10" />
    <label for="id-input-margin-x3">marginX3 :</label>
    <input type="number" id="id-input-margin-x3" name="margin-x3" min="0" value="30" />
    <label for="id-input-sc-x1">scX1 :</label>
    <input type="number" id="id-input-sc-x1" name="sc-x1" min="0" value="30" />
    <label for="id-input-sc-x3">scX3 :</label>
    <input type="number" id="id-input-sc-x3" name="sc-x3" min="0" value="70" />
  </div>
  <div style="margin: 8px" id="id-container-mtx">
    <div id="id-mtx-layer-0">
      <label id="id-label-mtx-layer-0-0">layer-0 : 0 (dot)</label>
      <input type="number" id="id-input-mtx-layer-0-0" min="0" max="511" >
      <label id="id-label-mtx-layer-0-1">1 (top edge)</label>
      <input type="number" id="id-input-mtx-layer-0-1" min="0" max="511" >
      <label id="id-label-mtx-layer-0-2">2 (left edge)</label>
      <input type="number" id="id-input-mtx-layer-0-2" min="0" max="511" >
      <label id="id-label-mtx-layer-0-3">3 (bottom edge)</label>
      <input type="number" id="id-input-mtx-layer-0-3" min="0" max="511" >
      <label id="id-label-mtx-layer-0-4">4 (right edge)</label>
      <input type="number" id="id-input-mtx-layer-0-4" min="0" max="511" >
      <label id="id-label-mtx-layer-0-5">5 (left top)</label>
      <input type="number" id="id-input-mtx-layer-0-5" min="0" max="511" >
      <label id="id-label-mtx-layer-0-6">6 (left bottom)</label>
      <input type="number" id="id-input-mtx-layer-0-6" min="0" max="511" >
      <label id="id-label-mtx-layer-0-7">7 (right bottom)</label>
      <input type="number" id="id-input-mtx-layer-0-7" min="0" max="511" >
      <label id="id-label-mtx-layer-0-8">8 (right top)</label>
      <input type="number" id="id-input-mtx-layer-0-8" min="0" max="511" >
      <label id="id-label-mtx-layer-0-9">9 (h-c-line)</label>
      <input type="number" id="id-input-mtx-layer-0-9" min="0" max="511" >
      <label id="id-label-mtx-layer-0-10">10 (v-c-line)</label>
      <input type="number" id="id-input-mtx-layer-0-10" min="0" max="511" >
      <label id="id-label-mtx-layer-0-11">11 (top line)</label>
      <input type="number" id="id-input-mtx-layer-0-11" min="0" max="511" >
      <label id="id-label-mtx-layer-0-12">12 (left line)</label>
      <input type="number" id="id-input-mtx-layer-0-12" min="0" max="511" >
      <label id="id-label-mtx-layer-0-13">13 (bottom line)</label>
      <input type="number" id="id-input-mtx-layer-0-13" min="0" max="511" >
      <label id="id-label-mtx-layer-0-14">14 (right line)</label>
      <input type="number" id="id-input-mtx-layer-0-14" min="0" max="511" >
    </div>
  </div>
  <div style="margin:8px">
    <button onclick="onClickReDraw()">re-draw</button>
  </div>
  <div style="margin: 8px">
    <button onclick="onClickSaveLayer()">save layer</button>
    <button onclick="onClickSaveRawInfo()">save rawInfo</button>
  </div>
  <div style="margin: 8px">
    <div>
      <input id="id-input-check-0" type="checkbox">
      <input id="id-input-check-1" type="checkbox">
      <input id="id-input-check-2" type="checkbox">
    </div>
    <div>
      <input id="id-input-check-3" type="checkbox">
      <input id="id-input-check-4" type="checkbox">
      <input id="id-input-check-5" type="checkbox">
    </div>
    <div>
      <input id="id-input-check-6" type="checkbox">
      <input id="id-input-check-7" type="checkbox">
      <input id="id-input-check-8" type="checkbox">
    </div>
  </div>
  <div style="margin: 8px">
    <button onclick="onClickSearchIndex()">search index</button>
    <label id="id-label-searched">searched index :</label>
  </div>
  <canvas id="id-canvas"></canvas>

  <script type="application/javascript" src="../sample-00/sample-00.js"></script>
  <script type="application/javascript" src="lib-drw-raw-expand.js"></script>
  <script type="application/javascript" src="lib-drw-raw-info-color-expand.js"></script>
  <script type="application/javascript" src="lib-drw-raw-layer.js"></script>
  <script type="application/javascript" src="lib-drw-raw-reverse.js"></script>
  <script type="application/javascript" src="lib-drw-raw-skin.js"></script>
  <script type="application/javascript" src="../sample-mtx/manager-mtx-preset-x3.js"></script>
  <script type="application/javascript" src="../sample-mtx/sample-mtx-preset-x3.js"></script>
  <script type="application/javascript" src="../sample-mtx/sample-mtx-preset-x3-b-set.js"></script>
  <script type="application/javascript" src="../sample-mtx/sample-mtx-preset-x3-skin.js"></script>
  <script type="application/javascript" src="../sample-mtx/sample-mtx-preset-x3-skin-part-indices.js"></script>
  <script type="application/javascript" src="../stage-proto/sample-drw-raw-info.js"></script>
  <script>
    let size = 6
    let rawIndex = 0 // max : 124 (length : 125)
    let marginX1 = 10
    let marginX3 = 30
    let scX1 = 30
    let scX3 = 70
    let rawInfo
    let bSet
    let mtxListList = []
    let canvas
    let ctx
    let rawInfoX3MtxSetList = []

    function init() {
      canvas = document.getElementById('id-canvas')
      ctx = canvas.getContext('2d')

      let canvasW = window.innerWidth - 8 * 2
      let canvasH = window.innerHeight - 8 * 2
      canvas.width = canvasW
      canvas.height = canvasH * 5

      // let size = 6
      // let rawIndex = 6
      // let marginX1 = 10
      // let marginX3 = 30
      // let scX1 = 30
      // let scX3 = 70

      const url = new URL(window.location)
      const searchParams = new URLSearchParams(url.search)
      let pSize = searchParams.get('size')
      if (pSize) size = pSize
      let pRawIndex = searchParams.get('rawIndex')
      if (pRawIndex) rawIndex = pRawIndex

      // let isSample = true
      // let pIsSample = searchParams.get('isSample')
      // if (pIsSample) isSample = (pIsSample === 'true') ? true : false

      let pMarginX1 = searchParams.get('marginX1')
      if (pMarginX1) marginX1 = pMarginX1
      let pMarginX3 = searchParams.get('marginX3')
      if (pMarginX3) marginX3 = pMarginX3
      let pScX1 = searchParams.get('scX1')
      if (pScX1) scX1 = pScX1
      let pScX3 = searchParams.get('scX3')
      if (pScX3) scX3 = pScX3

      const mtxContainer = document.getElementById('id-container-mtx')
      mtxContainer.innerHTML = ''
      changeRawInfo(rawIndex)
      // rawInfo = drwRawInfoSampleList[rawIndex]
      // if (isSample) rawInfo = mtxPresetX3SampleRawInfo02
      bSet = getMtxPresetX3SampleList()[mtxPresetX3BSetIndexList[0]].list

      console.log(drwRawInfoSampleList.length)

      // let topEdge = 46
      // let leftEdge = 46
      // let bottomEdge = 16
      // let rightEdge = leftEdge
      // let leftTop = 22
      // let leftBottom = 35
      // let rightBottom = leftBottom
      // let rightTop = leftTop
      // let hCLine = 12
      // let vCLine = 8
      // let topLine = 7
      // let leftLine = 12
      // let bottomLine = 14
      // let rightLine = leftLine

      // let mtx01 = [
      //   mtxPresetX3SampleList[511].list, // 0 : dot
      //   mtxPresetX3SampleList[presetTopEdge[topEdge]].list, // 1 : top edge
      //   mtxPresetX3SampleList[presetLeftEdge[leftEdge]].list, // 2 : left edge
      //   mtxPresetX3SampleList[presetBottomEdge[bottomEdge]].list, // 3 : bottom edge
      //   mtxPresetX3SampleList[presetRightEdge[rightEdge]].list, // 4 : right edge
      //   mtxPresetX3SampleList[presetLeftTop[leftTop]].list, // 5 : left top
      //   mtxPresetX3SampleList[presetLeftBottom[leftBottom]].list, // 6 : left bottom
      //   mtxPresetX3SampleList[presetRightBottom[rightBottom]].list, // 7 : right bottom
      //   mtxPresetX3SampleList[presetRightTop[rightTop]].list, // 8 : right top
      //   mtxPresetX3SampleList[presetHCLine[hCLine]].list, // 9 : horizontal center line
      //   mtxPresetX3SampleList[presetVCLine[vCLine]].list, // 10 : vertical center line
      //   mtxPresetX3SampleList[presetTopLine[topLine]].list, // 11 : top line
      //   mtxPresetX3SampleList[presetLeftLine[leftLine]].list, // 12 : left line
      //   mtxPresetX3SampleList[presetBottomLine[bottomLine]].list, // 13 : bottom line
      //   mtxPresetX3SampleList[presetRightLine[rightLine]].list // 14 : right line
      // ]

      // let mtxIndices01 = [511, 47, 46, 490, 0, 22, 35, 0, 0, 469, 135, 7, 12, 506, 0]
      // let mtxIndices01 = [511, 146, 121, 509, 0, 427, 473, 0, 0, 381, 466, 23, 89, 469, 0]
      // let mtxIndices01 = [511, 146, 121, 189, 0, 443, 473, 0, 0, 383, 466, 23, 89, 506, 0]
      // let mtxIndices01 = [511, 151, 249, 466, 0, 95, 473, 0, 0, 383, 365, 7, 73, 448, 0]
      // let mtxIndices01 = [511, 63, 249, 509, 0, 95, 473, 0, 0, 383, 511, 383, 479, 504, 0]
      // let mtxIndices01 = [189, 175, 413, 509, 0, 111, 234, 0, 0, 383, 490, 453, 409, 343, 0]
      // let mtx01 = getMtx(getMtxPresetX3SampleList(), mtxIndices01)

      // mtxListList = [
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[5]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[3]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[4]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0]),
      //   getMtxSet(getMtxPresetX3SampleList(), mtxPresetX3IndicesList[0])
      // ]

      draw()
    }

    function drawX3(ctx, i, rawInfo, row, layerList, rawInfoList, mtxList, bSet, size, sr, sc, margin) {
      const r = i % row
      const c = Math.floor(i / row)
      const layer = layerList[i]
      const rwInfoX3 = expandCheckRawCornerByMtxSetX3(layer, mtxList, bSet)
      rawInfoList.push(rwInfoX3)
      drawRawInfoExp(ctx, rwInfoX3, sr + margin * r, sc + margin * c, size, rbxLabSamplePalettesInfo00.list)
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height)

      const layerList = divideRawLayerToRawInfoList(rawInfo)
      let sr = 10
      let sc = 10
      let margin = marginX1
      let row = 20
      for (let i=0; i<layerList.length; i++) {
        const r = i % row
        const c = Math.floor(i / row)
        const layer = layerList[i]
        drawRawInfoExp(ctx, layer, sr + margin * r, sc + margin * c, size, rbxLabSamplePalettesInfo00.list)
      }

      for (const rwInfo of layerList) {
        drawRawInfoExp(ctx, rwInfo, sr, sc, size, rbxLabSamplePalettesInfo00.list)
      }

      const rawInfoX3 = expandRawSimple(rawInfo, 3)
      const rawX3LayerList = divideRawLayerToRawInfoList(rawInfoX3)
      sc = scX1
      margin = marginX3
      for (let i=0; i<rawX3LayerList.length; i++) {
        const r = i % row
        const c = Math.floor(i / row)
        const layer = rawX3LayerList[i]
        drawRawInfoExp(ctx, layer, sr + margin * r, sc + margin * c, size, rbxLabSamplePalettesInfo00.list)
      }

      for (const rwInfo of rawX3LayerList) {
        drawRawInfoExp(ctx, rwInfo, sr, sc, size, rbxLabSamplePalettesInfo00.list)
      }

      const rawX3MtxSetLayerList = divideRawLayerToRawInfoList(rawInfo)
      rawInfoX3MtxSetList = []
      sc = scX3
      for (let i=0; i<rawX3MtxSetLayerList.length; i++) {
        drawX3(ctx, i, rawInfo, row, rawX3MtxSetLayerList, rawInfoX3MtxSetList,
          mtxListList[i], bSet, size, sr, sc, margin)
      }

      for (const rwInfo of rawInfoX3MtxSetList) {
        drawRawInfoExp(ctx, rwInfo, sr, sc, size, rbxLabSamplePalettesInfo00.list)
      }
    }

    function changeRawInfo(index) {
      rawIndex = index
      rawInfo = drwRawInfoSampleList[rawIndex]

      const mtxPresetList = getMtxPresetX3SampleList()
      // mtxListList = []

      for (let i=0; i<=rawInfo.rawNum; i++) {
        if (mtxListList.length-1 >= i)  {
          const indicesList =  getMtxIndicesListFromInput(i)
          mtxListList[i] = getMtxSet(mtxPresetList, indicesList)
        } else {
          console.log(`add mtx : ${i}`)
          const index = i % mtxPresetX3IndicesList.length
          mtxListList.push(getMtxSet(mtxPresetList, mtxPresetX3IndicesList[index]))
          createMtxLayerDiv(i, mtxPresetX3IndicesList[index])
        }
      }
    }

    function getMtxIndicesListFromInput(layerIndex) {
      const length = 15
      const result = []
      for (let i=0; i<length; i++) {
        const id = `id-input-mtx-layer-${layerIndex}-${i}`
        const input = document.getElementById(id)
        result.push(Number(input.value))
      }
      return result
    }

    function createMtxLayerDiv(layerIndex, indicesList) {
      const layerDiv = document.createElement('div')
      layerDiv.id = `id-mtx-layer-${layerIndex}`
      layerDiv.style.margin = '6px'
      for (let i=0; i<indicesList.length; i++) {
        let labelText = ''
        if (i === 0) labelText = `layer-${layerIndex} : 0 (dot)`
        if (i === 1) labelText = '1 (top edge)'
        if (i === 2) labelText = '2 (left edge)'
        if (i === 3) labelText = '3 (bottom edge)'
        if (i === 4) labelText = '4 (right edge)'
        if (i === 5) labelText = '5 (left top)'
        if (i === 6) labelText = '6 (left bottom)'
        if (i === 7) labelText = '7 (right bottom)'
        if (i === 8) labelText = '8 (right top)'
        if (i === 9) labelText = '9 (h-c-line)'
        if (i === 10) labelText = '10 (v-c-line)'
        if (i === 11) labelText = '11 (top line)'
        if (i === 12) labelText = '12 (left line)'
        if (i === 13) labelText = '13 (bottom line)'
        if (i === 14) labelText = '14 (right line)'
        createMtxInput(layerDiv, layerIndex, i, labelText, indicesList[i])
      }
      const container = document.getElementById('id-container-mtx')
      container.appendChild(layerDiv)
    }

    function createMtxInput(layerDiv, layerIndex, index, labelText, inputValue) {
      // <label id="id-label-mtx-layer-0-0">layer-0 : 0 (dot)</label>
      // <input type="number" id="id-input-mtx-layer-0-0" min="0" max="511" >
      const label = document.createElement('label')
      const input = document.createElement('input')
      label.id = `id-label-mtx-layer-${layerIndex}-${index}`
      label.textContent = labelText
      label.style.fontSize = '9px'
      input.id = `id-input-mtx-layer-${layerIndex}-${index}`
      input.type = 'number'
      input.min = '0'
      input.max = '511'
      input.size = 4
      input.value = inputValue
      layerDiv.appendChild(label)
      layerDiv.appendChild(input)
    }

    function onClickReDraw() {
      console.log('onClickReDraw')
      const sizeInput = document.getElementById('id-input-size')
      const rawIndexInput = document.getElementById('id-input-raw-index')
      const marginX1Input = document.getElementById('id-input-margin-x1')
      const marginX3Input = document.getElementById('id-input-margin-x3')
      const scX1Input = document.getElementById('id-input-sc-x1')
      const scX3Input = document.getElementById('id-input-sc-x3')
      size = Number(sizeInput.value)
      // rawIndex = Number(rawIndexInput.value)
      marginX1 = Number(marginX1Input.value)
      marginX3 = Number(marginX3Input.value)
      scX1 = Number(scX1Input.value)
      scX3 = Number(scX3Input.value)

      // rawInfo = drwRawInfoSampleList[rawIndex]
      changeRawInfo(Number(rawIndexInput.value))

      draw()
    }

    function onClickSaveLayer() {
      console.log('onClickSaveLayer')
      console.log('---- save ---------------------------- start')
      for (let i=0; i<=rawInfo.rawNum; i++) {
        const indicesList =  getMtxIndicesListFromInput(i)
        console.log(`--------------- ${i}`)
        console.log(indicesList)

        const name = `${generateSimpleUCode()}-${rawInfo.uCode}-layer-${i}`
        saveString(indicesList.join(), name)
      }
      console.log('---- save ---------------------------- end')
    }

    function onClickSaveRawInfo() {
      console.log('onClickSaveRawInfo')
      const compRawInfo = compRawInfoLayers(rawInfoX3MtxSetList)
      compRawInfo.uCode = `${generateSimpleUCode()}-layer-comp-${rawInfo.uCode}`
      const str = parsingRawInfoToRawStr(compRawInfo)
      saveString(str, compRawInfo.uCode)

      let jsStrName = `js-${compRawInfo.uCode}`
      jsStrName = jsStrName.replaceAll('-', '_')
      const jsStr = startParsingObjToJS(jsStrName, compRawInfo)
      saveString(jsStr, jsStrName, 'js')
    }

    function onClickSearchIndex() {
      console.log('onClickSearchIndex')
      const list = []
      const length = 9
      for (let i=0; i<length; i++) {
        const input = document.getElementById(`id-input-check-${i}`)
        const v = (input.checked) ? 1 : 0
        list.push(v)
      }
      console.log(list)

      const index = findPresetIndexByRaw(list)
      console.log(`searched index : ${index}`)
      const label = document.getElementById('id-label-searched')
      label.textContent = `searched index : ${index}`
    }

    function generateSimpleUCode() {
      const current = new Date()
      const y = current.getFullYear()
      const m = current.getMonth() + 1
      const d = current.getDate()
      const h = current.getHours()
      const mm = current.getMinutes()
      const s = current.getSeconds()
      const mStr = (m < 10)? `0${m}`:`${m}`

      return `${y}${mStr}${d}${h}${mm}${s}`
    }

    function saveString(str, name, extension='txt') {
      const link = document.createElement("a")
      const file = new Blob([str], {type:'text/plain'})
      link.href = URL.createObjectURL(file)
      link.download = `${name}.${extension}`
      link.click()
      URL.revokeObjectURL(link.href)
    }

    function parsingRawInfoToRawStr(info) {
      return `${info.uCode}/${info.row}/${info.column}/${info.rawNum}/${info.raw.join()}`
    }

    function startParsingObjToJS(name, obj) {
      let result = `const ${name} = `
      result += parsingObjToJS(obj)
      return result
    }

    function parsingObjToJS(obj, prev='') {
      let result = '{\n'
      let hasKey = false
      for (const [key, value] of Object.entries(obj)) {
        hasKey = true
        result += prev + ' ' + key + ': '
        if (Object.prototype.isPrototypeOf(value)) {
          if (Array.isArray(value)) {
            result += '['
            if (value.length > 0) {
              if (Object.prototype.isPrototypeOf(value[0])) {
                if (Array.isArray(value[0])) {
                  for (const v of value) {
                    result += '[' + v + ']'
                  }
                  result = result.slice(0, result.length-1)
                } else {
                  for (const v of value) {
                    result += parsingObjToJS(v, prev + ' ') + ','
                  }
                  result = result.slice(0, result.length-1)
                }
              } else {
                result += value
              }
            }
            result += '],\n'
          } else {
            result += parsingObjToJS(value, prev + ' ') + ',\n'
          }
        } else if (typeof  value === 'string') {
          result += '\"' + value + '\",\n'
        } else {
          result += value + ',\n'
        }
      }
      if (hasKey) result = result.slice(0, result.length-2) + '\n'
      result += prev + '}'
      return result
    }
  </script>
</body>
</html>